---
title: "Wykorzystanie pakietu nonprobsvy (2023.12.08)"
author: "Maciej Beręsewicz & Łukasz Chrostowski"
format: 
  html:
    self-contained: true
    table-of-contents: true
    df-print: kable
---

# Informacje

Szkolenie sfinansowane w ramach projektu "Statystyka cudzoziemców bez spisu powszechnego - jakość, integracja danych i estymacja" (opis) finansowanego z grantu Narodowego Centrum Nauki OPUS 20 (2020/39/B/HS4/00941).

# Instalacje i pakiety

Instalujemy pakiet `remotes`.

```{r install, eval=FALSE}
install.packages("remotes") ## do instalacji pakietu nonprobsvy
install.packages("ggplot2") ## do wizualiacji 
install.packages("survey") ## do estymacji na podstawie prób losowych
remotes::install_github("ncn-foreigners/nonprobsvy")
```
Ładujemy pakiet `nonprobsvy`.

```{r pakiety, message = FALSE}
library(nonprobsvy) ## do prób nielosowych
library(survey) ## do badania popyt na pracę
library(ggplot2) ## do wizualizacji
```

# Dane na szkolenie

Zbiory danych znajdują się w folderze `data-raw/`:

+ plik `popyt.csv` -- zawiera zanonimizowane dane o podmiotach posiadających przynajmniej jedno wolne miejsce pracy z badania [Popyt na pracę](https://stat.gov.pl/obszary-tematyczne/rynek-pracy/popyt-na-prace/) (PnP) pozyskane przez Instytut Informatyki i Gospodarki Ilościowej UEP.
+ plik `cbop.csv` -- zawiera zanonimizowane dane podmiotów, będących w populacji badania PnP, z [Centralnej Bazy Ofert Pracy](https://oferty.praca.gov.pl/portal/index.cbop#/listaOfert) pobrane przez CBOP API.

Zbiory danych zawierają następujące kolumny:

+ `id_jednostki` -- unikalny identyfikator jednostki,
+ `sektor` - 0=publiczny, 1=prywatny,
+ `pkd` - sekcje pkd (od C do S; sekcje połączone: D i E, K i L, R i S),
+ `woj` - województwo
+ `waga` (tylko `popyt`) -- waga finalna ustalona w ramach badania PnP,
+ `jedna_zmiana` (tylko `cbop`) -- czy podmiot zatrudnia osoby na jedną zmianę (na podstawie zmiennej `kodZmianowości`, więcej na [CBOP dla integratorów](https://oferty.praca.gov.pl/portal/index.cbop#/dlaInt)).

Wczytujemy dane

```{r wczytanie}
popyt <- read.csv("../data-raw/popyt.csv",
                  colClasses = c("character", "numeric", rep("character", 3), "numeric"))
head(popyt)
```
Deklarujemy obiekt `svydesign`. Dla uproszczenie zakłdamy, że warstwy określone są przez 3 zmienne: `klasa`, `pkd` i `woj`. W praktyce schemat losowania jest troszkę inny (por. [Zeszyt metodologiczny badania PnP](https://stat.gov.pl/obszary-tematyczne/rynek-pracy/popyt-na-prace/zeszyt-metodologiczny-popyt-na-prace,3,1.html)).

```{r schemat}
popyt_svy <- svydesign(ids = ~1,  ## losujemy jednostki, a nie zespoły
                       weights = ~waga,  ## waga finalna
                       strata = ~ klasa + pkd + woj,  ## warstwy
                       data = popyt) ## dane

svytotal(~klasa, popyt_svy)
```

```{r wczytanie2}
cbop <- read.csv("../data-raw/cbop.csv", 
                 colClasses = c("character", "numeric", rep("character", 3), "logical")
                 )
head(cbop)
```
Odsetek podmiotów zatrudniających na jedną zmianę na podstawie danych CBOP bez korekty wynosi: `r round(mean(cbop$jedna_zmiana)*100,2)`.

# Estymator IPW

## Standardowy estymator

```{r}
est1_logit <- nonprob(
  selection = ~ woj + sektor + pkd + klasa,
  target = ~ jedna_zmiana,
  svydesign = popyt_svy,
  data = cbop,
  method_selection = "logit"
)

est1_probit <- nonprob(
  selection = ~ woj + sektor + pkd + klasa,
  target = ~ jedna_zmiana,
  svydesign = popyt_svy,
  data = cbop,
  method_selection = "probit"
)

est1_cloglog <- nonprob(
  selection = ~ woj + sektor + pkd + klasa,
  target = ~ jedna_zmiana,
  svydesign = popyt_svy,
  data = cbop,
  method_selection = "cloglog"
)

est_ipw_standard <- rbind(cbind(est1_logit$output, est1_logit$confidence_interval),
                          cbind(est1_probit$output, est1_probit$confidence_interval),
                          cbind(est1_cloglog$output, est1_cloglog$confidence_interval))
est_ipw_standard$est <- "ipw"
rownames(est_ipw_standard) <- NULL
est_ipw_standard
```

Strukura obiektu

```{r}
str(est1_logit,1)
```
Informacje o modelu regresji logistycznej będącym podstawą estymatora IPW.

```{r}
str(est1_logit$selection,1)
```

Metoda summary

```{r summary}
summary(est1_logit)
```

## Estymator kalibrowany

```{r}
est2_logit <- nonprob(
  selection = ~ woj + sektor + pkd + klasa,
  target = ~ jedna_zmiana,
  svydesign = popyt_svy,
  data = cbop,
  method_selection = "logit",
  control_selection = controlSel(h = 1, est_method_sel = "gee")
)

est2_probit <- nonprob(
  selection = ~ woj + sektor + pkd + klasa,
  target = ~ jedna_zmiana,
  svydesign = popyt_svy,
  data = cbop,
  method_selection = "probit",
  control_selection = controlSel(h = 1, est_method_sel = "gee")
)

est2_cloglog <- nonprob(
  selection = ~ woj + sektor + pkd + klasa,
  target = ~ jedna_zmiana,
  svydesign = popyt_svy,
  data = cbop,
  method_selection = "cloglog",
  control_selection = controlSel(h = 1, est_method_sel = "gee")
)

est_ipw_calib <- rbind(cbind(est2_logit$output, est2_logit$confidence_interval),
                          cbind(est2_probit$output, est2_probit$confidence_interval),
                          cbind(est2_cloglog$output, est2_cloglog$confidence_interval))
est_ipw_calib$est <- "ipw calib"
rownames(est_ipw_calib) <- NULL
est_ipw_calib
```

Porównanie wartości globalnych pierwszego i drugiego IPW (dla logit)

```{r}
cbop$ipw1_waga <- est1_logit$weights
cbop$ipw2_waga <- est2_logit$weights
```

Liczba podmiotów:

```{r}
c(popyt=sum(weights(popyt_svy)), ipw1=sum(cbop$ipw1_waga), ipw2=sum(cbop$ipw2_waga))
```

Wagi według wielkości podmiotu

```{r}
svytotal(~klasa, popyt_svy)
```
```{r}
xtabs(ipw1_waga ~ klasa, cbop)
xtabs(ipw2_waga ~ klasa, cbop)
```

## Estymacja wariancji metodą bootstrap

```{r ipw-bootstrap}
est3_logit <- nonprob(
  selection = ~ woj + sektor + pkd + klasa,
  target = ~ jedna_zmiana,
  svydesign = popyt_svy,
  data = cbop,
  method_selection = "logit",
  control_inference = controlInf(var_method = "bootstrap", num_boot = 50),
  verbose = T, 
)
```
```{r}
summary(est3_logit)
```

## Dobór zmiennych do modelu

Dobór zmiennych z wykorzystaniem metody SCAD.

```{r ipw-scad}
est4_logit <- nonprob(
  selection = ~ woj + sektor + pkd + klasa,
  target = ~ jedna_zmiana,
  svydesign = popyt_svy,
  data = cbop,
  method_selection = "logit",
  control_selection = controlSel(nfolds = 5, nlambda = 25),
  control_inference = controlInf(vars_selection = TRUE),
  verbose = TRUE
)
```

```{r}
summary(est4_logit)
```

Porównanie estymatorów dla logit

```{r}
ipw_summary <- rbind(cbind(est1_logit$output, est1_logit$confidence_interval),
                     cbind(est2_logit$output, est2_logit$confidence_interval),
                     cbind(est3_logit$output, est3_logit$confidence_interval),
                     cbind(est4_logit$output, est4_logit$confidence_interval))
rownames(ipw_summary) <- NULL
ipw_summary$est <- c("ipw", "ipw cal", "ipw boot", "ipw scad")
```


# Estymator MI

```{r}

```

